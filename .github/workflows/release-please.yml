name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: go

  build-linux-amd64:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404
    env:
      FFMPEG_VERSION: "8.0"
    steps:
      - uses: actions/checkout@v4

      - name: Mount ccache sticky disk
        uses: useblacksmith/stickydisk@v1
        with:
          key: ccache-linux-amd64-${{ env.FFMPEG_VERSION }}
          path: ~/.ccache

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.6'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config ccache libmp3lame-dev

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Build ffmpeg from source
        run: |
          mkdir -p embed/ffmpeg
          curl -L -o ffmpeg.tar.xz "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
          tar xf ffmpeg.tar.xz
          cd "ffmpeg-${FFMPEG_VERSION}"
          ../scripts/ffmpeg-configure.sh \
            --prefix="$(pwd)/out" \
            --extra-ldflags="-static" \
            --cc="ccache gcc"
          make -j$(nproc)
          cp ffmpeg ../embed/ffmpeg/ffmpeg_linux_amd64
          strip ../embed/ffmpeg/ffmpeg_linux_amd64 || true

      - name: Show ccache stats
        run: ccache -s

      - name: Build Go binary
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          go build -trimpath -ldflags='-s -w' -o "audio-extractor" .

      - name: Create release archive
        run: |
          ARCHIVE_NAME="audio-extractor_${{ needs.release-please.outputs.version }}_linux-x64.tar.gz"
          tar -czvf "${ARCHIVE_NAME}" audio-extractor
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-extractor-linux-x64
          path: ${{ env.ARCHIVE_NAME }}

  build-linux-arm64:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404-arm
    env:
      FFMPEG_VERSION: "8.0"
    steps:
      - uses: actions/checkout@v4

      - name: Mount ccache sticky disk
        uses: useblacksmith/stickydisk@v1
        with:
          key: ccache-linux-arm64-${{ env.FFMPEG_VERSION }}
          path: ~/.ccache

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.6'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config ccache libmp3lame-dev

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Build ffmpeg from source
        run: |
          mkdir -p embed/ffmpeg
          curl -L -o ffmpeg.tar.xz "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
          tar xf ffmpeg.tar.xz
          cd "ffmpeg-${FFMPEG_VERSION}"
          ../scripts/ffmpeg-configure.sh \
            --prefix="$(pwd)/out" \
            --extra-ldflags="-static" \
            --cc="ccache gcc"
          make -j$(nproc)
          cp ffmpeg ../embed/ffmpeg/ffmpeg_linux_arm64
          strip ../embed/ffmpeg/ffmpeg_linux_arm64 || true

      - name: Show ccache stats
        run: ccache -s

      - name: Build Go binary
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -trimpath -ldflags='-s -w' -o "audio-extractor" .

      - name: Create release archive
        run: |
          ARCHIVE_NAME="audio-extractor_${{ needs.release-please.outputs.version }}_linux-arm64.tar.gz"
          tar -czvf "${ARCHIVE_NAME}" audio-extractor
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-extractor-linux-arm64
          path: ${{ env.ARCHIVE_NAME }}

  build-macos:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    env:
      FFMPEG_VERSION: "8.0"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.6'

      - name: Install build dependencies
        run: |
          brew install nasm pkg-config ccache lame

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: ccache-macos-arm64-${{ env.FFMPEG_VERSION }}
          restore-keys: |
            ccache-macos-arm64-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Build ffmpeg from source
        run: |
          mkdir -p embed/ffmpeg
          curl -L -o ffmpeg.tar.xz "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.xz"
          tar xf ffmpeg.tar.xz
          cd "ffmpeg-${FFMPEG_VERSION}"
          ../scripts/ffmpeg-configure.sh \
            --prefix="$(pwd)/out" \
            --cc="ccache clang" \
            --extra-cflags="-I$(brew --prefix lame)/include" \
            --extra-ldflags="-L$(brew --prefix lame)/lib"
          make -j$(sysctl -n hw.ncpu)
          cp ffmpeg ../embed/ffmpeg/ffmpeg_darwin_arm64
          strip ../embed/ffmpeg/ffmpeg_darwin_arm64 || true

      - name: Show ccache stats
        run: ccache -s

      - name: Build Go binary
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -trimpath -ldflags='-s -w' -o "audio-extractor" .

      - name: Create release archive
        run: |
          ARCHIVE_NAME="audio-extractor_${{ needs.release-please.outputs.version }}_macos-arm64.tar.gz"
          tar -czvf "${ARCHIVE_NAME}" audio-extractor
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-extractor-macos-arm64
          path: ${{ env.ARCHIVE_NAME }}

  upload-release-assets:
    needs: [release-please, build-linux-amd64, build-linux-arm64, build-macos]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in artifacts/*/; do
            for file in "$dir"*; do
              gh release upload "${{ needs.release-please.outputs.tag_name }}" "$file" --repo ${{ github.repository }}
            done
          done

  # Docker image builds for linux/amd64 and linux/arm64
  docker-build-amd64:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Builder
        uses: useblacksmith/setup-docker-builder@v1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Build and push Docker image
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          push: true
          platforms: linux/amd64
          provenance: false
          sbom: false
          tags: |
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-amd64
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-amd64

  docker-build-arm64:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404-arm
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Builder
        uses: useblacksmith/setup-docker-builder@v1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Build and push Docker image
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          push: true
          platforms: linux/arm64
          provenance: false
          sbom: false
          tags: |
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-arm64
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-arm64

  docker-merge-manifest:
    needs: [release-please, docker-build-amd64, docker-build-arm64]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Create and push multi-arch manifest (versioned)
        run: |
          docker manifest create public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }} \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-amd64 \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-arm64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }} \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-amd64 --arch amd64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }} \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-arm64 --arch arm64
          docker manifest push public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}

      - name: Create and push multi-arch manifest (latest)
        run: |
          docker manifest create public.ecr.aws/m2l9b6l8/audio-extractor:latest \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-amd64 \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-arm64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:latest \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-amd64 --arch amd64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:latest \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-arm64 --arch arm64
          docker manifest push public.ecr.aws/m2l9b6l8/audio-extractor:latest
