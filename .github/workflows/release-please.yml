name: Release Please

on:
  push:
    branches:
      - main

env:
  # renovate: datasource=github-releases depName=FFmpeg/FFmpeg extractVersion=^n(?<version>.*)$
  FFMPEG_VERSION: "8.0"
  # renovate: datasource=docker depName=golang
  GO_VERSION: "1.25.6"

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release-please:
    runs-on: blacksmith-2vcpu-ubuntu-2404
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: go
          prerelease: true

  download-ffmpeg:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v6

      - name: Cache ffmpeg source
        id: cache
        uses: actions/cache@v5
        with:
          path: ffmpeg.tar.xz
          key: ffmpeg-source-${{ env.FFMPEG_VERSION }}

      - name: Download ffmpeg source
        if: steps.cache.outputs.cache-hit != 'true'
        run: ./scripts/download-ffmpeg.sh

      - name: Upload ffmpeg source artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-source
          path: ffmpeg.tar.xz
          retention-days: 1

  build-linux-amd64:
    needs: [release-please, download-ffmpeg]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v6

      - name: Download ffmpeg source
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-source

      - name: Mount ccache sticky disk
        uses: useblacksmith/stickydisk@v1
        with:
          key: ccache-linux-amd64-${{ env.FFMPEG_VERSION }}
          path: ~/.ccache

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config ccache libmp3lame-dev

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Build ffmpeg
        run: |
          mkdir -p embed/ffmpeg
          ./scripts/build-ffmpeg.sh embed/ffmpeg/ffmpeg_linux_amd64 --cc="ccache gcc"

      - name: Show ccache stats
        run: ccache -s

      - name: Build Go binary
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          COMMIT="${{ github.sha }}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          LDFLAGS="-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}"
          go build -trimpath -ldflags="${LDFLAGS}" -o "audio-extractor" .

      - name: Create release archive
        run: |
          ARCHIVE_NAME="audio-extractor_${{ needs.release-please.outputs.version }}_linux-x64.tar.gz"
          tar -czvf "${ARCHIVE_NAME}" audio-extractor
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: audio-extractor-linux-x64
          path: ${{ env.ARCHIVE_NAME }}

  build-linux-arm64:
    needs: [release-please, download-ffmpeg]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404-arm
    steps:
      - uses: actions/checkout@v6

      - name: Download ffmpeg source
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-source

      - name: Mount ccache sticky disk
        uses: useblacksmith/stickydisk@v1
        with:
          key: ccache-linux-arm64-${{ env.FFMPEG_VERSION }}
          path: ~/.ccache

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm pkg-config ccache libmp3lame-dev

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Build ffmpeg
        run: |
          mkdir -p embed/ffmpeg
          ./scripts/build-ffmpeg.sh embed/ffmpeg/ffmpeg_linux_arm64 --cc="ccache gcc"

      - name: Show ccache stats
        run: ccache -s

      - name: Build Go binary
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          COMMIT="${{ github.sha }}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          LDFLAGS="-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}"
          go build -trimpath -ldflags="${LDFLAGS}" -o "audio-extractor" .

      - name: Create release archive
        run: |
          ARCHIVE_NAME="audio-extractor_${{ needs.release-please.outputs.version }}_linux-arm64.tar.gz"
          tar -czvf "${ARCHIVE_NAME}" audio-extractor
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: audio-extractor-linux-arm64
          path: ${{ env.ARCHIVE_NAME }}

  build-macos:
    needs: [release-please, download-ffmpeg]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download ffmpeg source
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-source

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install build dependencies
        run: |
          brew install nasm pkg-config ccache lame

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/ccache
          key: ccache-macos-arm64-${{ env.FFMPEG_VERSION }}
          restore-keys: |
            ccache-macos-arm64-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Build ffmpeg
        run: |
          mkdir -p embed/ffmpeg
          ./scripts/build-ffmpeg.sh embed/ffmpeg/ffmpeg_darwin_arm64 --cc="ccache clang"

      - name: Show ccache stats
        run: ccache -s

      - name: Build Go binary
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          COMMIT="${{ github.sha }}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          LDFLAGS="-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}"
          go build -trimpath -ldflags="${LDFLAGS}" -o "audio-extractor" .

      - name: Create release archive
        run: |
          ARCHIVE_NAME="audio-extractor_${{ needs.release-please.outputs.version }}_macos-arm64.tar.gz"
          tar -czvf "${ARCHIVE_NAME}" audio-extractor
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: audio-extractor-macos-arm64
          path: ${{ env.ARCHIVE_NAME }}

  upload-release-assets:
    needs: [release-please, build-linux-amd64, build-linux-arm64, build-macos]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          pattern: audio-extractor-*

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in artifacts/*/; do
            for file in "$dir"*; do
              gh release upload "${{ needs.release-please.outputs.tag_name }}" "$file" --repo ${{ github.repository }}
            done
          done

  # Docker image builds for linux/amd64 and linux/arm64
  docker-build-amd64:
    needs: [release-please, download-ffmpeg]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Download ffmpeg source
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-source

      - name: Set up Docker Builder
        uses: useblacksmith/setup-docker-builder@v1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Build and push Docker image
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          push: true
          platforms: linux/amd64
          provenance: false
          sbom: false
          build-args: |
            VERSION=${{ needs.release-please.outputs.version }}
            COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
          tags: |
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-amd64
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-amd64

  docker-build-arm64:
    needs: [release-please, download-ffmpeg]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-8vcpu-ubuntu-2404-arm
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Download ffmpeg source
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-source

      - name: Set up Docker Builder
        uses: useblacksmith/setup-docker-builder@v1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Build and push Docker image
        uses: useblacksmith/build-push-action@v2
        with:
          context: .
          push: true
          platforms: linux/arm64
          provenance: false
          sbom: false
          build-args: |
            VERSION=${{ needs.release-please.outputs.version }}
            COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
          tags: |
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-arm64
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-arm64

  docker-merge-manifest:
    needs: [release-please, docker-build-amd64, docker-build-arm64]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: us-east-1

      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Create and push multi-arch manifest (versioned)
        run: |
          docker manifest create public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }} \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-amd64 \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-arm64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }} \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-amd64 --arch amd64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }} \
            public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}-arm64 --arch arm64
          docker manifest push public.ecr.aws/m2l9b6l8/audio-extractor:${{ needs.release-please.outputs.version }}

      - name: Create and push multi-arch manifest (latest)
        run: |
          docker manifest create public.ecr.aws/m2l9b6l8/audio-extractor:latest \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-amd64 \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-arm64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:latest \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-amd64 --arch amd64
          docker manifest annotate public.ecr.aws/m2l9b6l8/audio-extractor:latest \
            public.ecr.aws/m2l9b6l8/audio-extractor:latest-arm64 --arch arm64
          docker manifest push public.ecr.aws/m2l9b6l8/audio-extractor:latest

  publish-release:
    needs: [release-please, upload-release-assets, docker-merge-manifest]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "${{ needs.release-please.outputs.tag_name }}" --repo ${{ github.repository }} --prerelease=false --latest
